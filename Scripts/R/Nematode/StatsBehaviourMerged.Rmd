---
title: "Statistical analysis for the temporal variation of behaviour"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
 
```{r load packages, echo=FALSE}
library(tidyverse)
library(EnvStats)
library(DHARMa)
library(multcomp)
library(glmmTMB)
library(multcomp)
```

```{r load data}
AntTable <- read_csv(here::here("Data/outputAntTableMergedJoined.csv"))
InfectionStatus <- read_delim(here::here("Data/antInfectionStatus.csv"), delim = ";")
```

```{r data wrangling}
left_join(AntTable, InfectionStatus, by = c("ColonyID", "Colour", "InfectionStatus", "InfectionLoad", "Treatment")) %>% 
  mutate(
    TreatmentInfectionStatus = as.factor(paste0(Treatment, "_", InfectionStatus)),
    Treatment = as.factor(Treatment),
    InfectionStatus = as.factor(InfectionStatus))  -> AntTableFull
```

```{r}
AntTableFull %>% 
  filter(AssignmentRate > 0.5) %>% 
  ggplot(aes(x = TreatmentInfectionStatus, y = OutNestRatio)) +
  geom_jitter(aes(color = TreatmentInfectionStatus), alpha = 0.5) +
  geom_violin(aes(fill = TreatmentInfectionStatus), color = "darkgray", lwd=0.3, alpha = 0.4) +
  geom_boxplot(aes(color = TreatmentInfectionStatus), fill = "darkgray", alpha = 0.7, outlier.shape = NA, width=0.05) +
  #scale_color_manual(name = "Colony Treatment", labels = c("Infected", "Mixed"), values = c("T" = "#D95319", "X" = "#7E2F8E")) +
  stat_n_text()+
  theme_bw(base_size = 14) +
  theme(legend.position = "bottom") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))


AntTableFull %>% 
  filter(ColonyID == "X_9" | ColonyID == "T_9" ) -> AntTableFullCrop

AntTableFull %>% 
  count(TreatmentInfectionStatus)
```

```{r model for in nest}
# generalised linear mixed model
glmerOutNestTreatmentInfectionStatus <- glmer(cbind(OutNestFrame, InNestFrame) ~ TreatmentInfectionStatus + (1| ColonyID)
                                              , data = AntTableFull, family = binomial())
cov2cor(vcov(glmerOutNestTreatmentInfectionStatus))
summary(glmerOutNestTreatmentInfectionStatus)
# random effect compete with 

glmerOutNestTreatmentInfectionStatus <- glmmTMB(OutNestRatio ~ TreatmentInfectionStatus + (1| ColonyID), data = AntTableFull, family = beta_family())
glmerOutNestTreatmentInfectionStatusGaussian <- glmmTMB(OutNestRatio ~ TreatmentInfectionStatus + (1| ColonyID), data = AntTableFull, family = gaussian())
AIC(glmerOutNestTreatmentInfectionStatus, glmerOutNestTreatmentInfectionStatusGaussian)

foo <- vcov(glmerOutNestTreatmentInfectionStatus)

cov2cor(foo[[1]])
summary(glmerOutNestTreatmentInfectionStatus)

glmOutNestTreatmentInfectionStatus <- glm(cbind(OutNestFrame, InNestFrame) ~ TreatmentInfectionStatus + ColonyID
                                              , data = AntTableFull, family = binomial())
cov2cor(vcov(glmOutNestTreatmentInfectionStatus))

glmOutNestTreatmentInfectionStatusCrop <- glm(cbind(OutNestFrame, InNestFrame) ~ TreatmentInfectionStatus
                                              , data = AntTableFull, family = binomial())
cov2cor(vcov(glmOutNestTreatmentInfectionStatusCrop))


testDispersion(glmerOutNestTreatmentInfectionStatus)
simulationOutput <- simulateResiduals(fittedModel = glmerOutNestTreatmentInfectionStatus, plot = F)
plot(simulationOutput)
summary(glmerOutNestTreatmentInfectionStatus)
Anova(glmerOutNestTreatmentInfectionStatus)

AIC()
# Conclussion: when analysing binomial data, trials have to be independent (which is not the case for the frames, autocorrelation). 

posthocGlmerOutNestTreatmentInfectionStatus <- glht(glmerOutNestTreatmentInfectionStatus, linfct = mcp(TreatmentInfectionStatus = "Tukey"))
summary(posthocGlmerOutNestTreatmentInfectionStatus)
par(mar = c(4, 20, 2, 2))
plot(posthocGlmerOutNestTreatmentInfectionStatus)

# glmerOutNestTreatmentInfectionStatusSub1 <- glmer(Mean ~ TreatmentInfectionStatus + (1|ColonyID), data = subset(AntTableFull, TreatmentInfectionStatus == "X_uninfected" | TreatmentInfectionStatus == "X_infected"), family = binomial())
# summary(glmerOutNestTreatmentInfectionStatusSub1)
# pValue = c(0.5,0.005,2e-16 )
# p.adjust(pValue, method = "bonferroni")

```

```{r model for speed}
# linear mixed model
lmerSpeedTreatmentInfectionStatus <- lmer(MeanSpeed ~ TreatmentInfectionStatus + (1|ColonyID), data = AntTableFull)
#predict gives the predicted value in terms of logits
plot.dat <- data.frame(prob = AntTableFull$OutNestFrame/AntTableFull$TotalFrame,
                       fit = predict(glmerOutNestTreatmentInfectionStatusSub1, menarche))
#convert those logit values to probabilities
plot.dat$fit_prob <- exp(plot.dat$fit)/(1+exp(plot.dat$fit))

lmerSpeedTreatmentInfectionStatus <- lmer(MeanSpeed ~ TreatmentInfectionStatus + (1|ColonyID), data = AntTableFull,)
testDispersion(lmerSpeedTreatmentInfectionStatus)
simulationOutput <- simulateResiduals(fittedModel = lmerSpeedTreatmentInfectionStatus, plot = F)
plot(simulationOutput)
summary(lmerSpeedTreatmentInfectionStatus)

posthocLmerSpeedTreatmentInfectionStatus <- glht(lmerSpeedTreatmentInfectionStatus, linfct = mcp(TreatmentInfectionStatus = "Tukey"))
summary(posthocLmerSpeedTreatmentInfectionStatus)

glmerOutNestTreatmentInfectionStatusSub1 <- glmer(Mean ~ TreatmentInfectionStatus + (1|ColonyID), data = subset(AntTableFull, TreatmentInfectionStatus == "X_uninfected" | TreatmentInfectionStatus == "X_infected"), family = binomial())
summary(glmerOutNestTreatmentInfectionStatusSub1)
pValue = c(0.5,0.005,2e-16 )
p.adjust(pValue, method = "bonferroni")

```

